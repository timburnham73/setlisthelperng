<div class="container" fxLayoutGap="5px grid" fxLayout="row" fxLayoutAlign="center none">
  <!-- Mobile Layout container -->
  <div fxFlex="100%" fxfill fxlayout="column" class="mobile-card-container" fxShow fxHide.gt-md>
    <mat-toolbar>
      @if(showRemove === false) {
      <button mat-button aria-label="Add Song or Break" [matMenuTriggerFor]="addSong">
        <mat-icon>add</mat-icon>
      </button>
      <mat-menu #addSong="matMenu" xPosition="after" yPosition="above" [overlapTrigger]="false">

        <a mat-menu-item (click)="onAddSong()">
          <span>Add New Song</span>
        </a>

        <a mat-menu-item (click)="onAddBreak()">
          <span>Add Break</span>
        </a>
        <a mat-menu-item (click)="onAddFromCatalog()">
          <span>Add From Catalog</span>
        </a>
      </mat-menu>
      <button mat-button aria-label="Print Setlist" (click)="onPrintSetlist()">
        <mat-icon>print</mat-icon>
      </button>
      <button mat-button aria-label="Remove Song" (click)="onEnableDeleteMode()">
        <span>Delete</span>
      </button>
      
      } @else {
      <button mat-icon-button aria-label="Stop Remove Song" (click)="onEnableDeleteMode()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      }
    </mat-toolbar>
    <mat-card-content *ngFor="let song of dsSetlistSongs.data" (click)="onViewLyrics($event, song)">
      
      <div class="grid b-b-1" [ngClass]="{ setbreak: song.isBreak }">
        <div class="col-1">
          <div class="text-center pt-3 top-50 font-bold">
            {{
            song.isBreak === true
            ? incrementSetBreakCount(
            dsSetlistSongs.filteredData.indexOf(song)
            )
            : getSequenceNumber(
            dsSetlistSongs.filteredData.indexOf(song)
            )
            }}
          </div>
        </div>
        <div class="col-10 pt-3">
          <div><b>{{song.name}}</b></div>
          <div>{{songService.getSongDetails(song)}}</div>
        </div>
        <div class="col-1">
          <div class="flex justify-content-end">
            @if(!showRemove){
              <button mat-icon-button aria-label="Add Song or Break" (click)="$event.stopPropagation()" [matMenuTriggerFor]="songMoremenu">
                <mat-icon>expand_circle_down</mat-icon>
              </button>
              <mat-menu #songMoremenu="matMenu" xPosition="after" yPosition="above" [overlapTrigger]="false">
                <a mat-menu-item (click)="onEditSong(song)">
                  <span>Edit...</span>
                </a>
                <a mat-menu-item (click)="onAddSong(song)">
                  <span>Add New Song...</span>
                </a>
        
                <a mat-menu-item (click)="onAddBreak(song)">
                  <span>Add Break...</span>
                </a>
                <a mat-menu-item (click)="onAddFromCatalog(song)">
                  <span>Add From Catalog...</span>
                </a>
              </mat-menu>
            }
            @else{
              <button mat-icon-button aria-label="Edit Song" (click)="$event.stopPropagation(); onRemoveSong($event, song)">
                <mat-icon>delete</mat-icon>
              </button>
            }
          </div>

        </div>
      </div>
    </mat-card-content>
  </div>
  <!-- Songs Grid -->
  <div fxFlex="24%" fxShow fxHide.lt-lg>
    <mat-card>
      <mat-card-content class="card-content">
        <mat-toolbar>
          <span class="spacer"></span>
          <form class="search-form">
            <mat-form-field  appearance="outline"  subscriptSizing="dynamic">
              <mat-label>Search</mat-label>
              <input type="text" matInput placeholder="Search" (keyup)="search(input.value)" #input />
            </mat-form-field>
          </form>
        </mat-toolbar>
        <div class="table-container">
          <table cdkDropList [cdkDropListData]="filteredSongs" [cdkDropListConnectedTo]="[setlistSongList]" mat-table
            [dataSource]="filteredSongs" matSort #songList="cdkDropList">
            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
              <td mat-cell *matCellDef="let element">{{ element.name }}</td>
            </ng-container>

            <!-- Artist Column -->
            <ng-container matColumnDef="artist">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Artist</th>
              <td mat-cell *matCellDef="let element">
                {{ element.artist }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedSongColumns; sticky: true"></tr>
            <tr cdkDrag [cdkDragData]="row" mat-row (dblclick)="onAddSetlistSong(row)"
              *matRowDef="let row; columns: displayedSongColumns"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Setlist Songs Grid -->
  <div fxFlex="74%" fxShow fxHide.lt-lg>
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <span *ngIf="this.setlist?.name">{{this.setlist?.name}}</span> 
          <span *ngIf="this.setlist?.gigLocation"> - {{this.setlist?.gigLocation}}</span> 
          <span *ngIf="this.setlist?.gigDate"> - {{ this.setlist?.gigDate?.toDate() | date:'MM/dd/yyyy h:mm:ss a'}}</span> 
        </mat-card-title>
        <mat-card-subtitle>
          <span class="subtitle"  *ngIf="this.setlist?.totalTimeInSeconds"><b>Total Time:</b> {{ getSetlistTotalTimeInSeconds() * 1000 | date:'mm:ss'}}</span>
          <span class="subtitle"  *ngIf="this.setlist?.totalTimeInSeconds"><b>Song Count:</b> {{ this.setlist?.countOfSongs}}</span>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content class="card-content">
        <mat-toolbar>
          @if(showRemove === false) {
            <button mat-button aria-label="Add Song or Break" [matMenuTriggerFor]="addSong">
            <mat-icon>add</mat-icon>
            <span fxShow fxHide.xs>
              Add
            </span>
          </button>
          <mat-menu #addSong="matMenu" xPosition="after" yPosition="above" [overlapTrigger]="false">

            <a mat-menu-item (click)="onAddSong()">
              <span>Add New Song</span>
            </a>

            <a mat-menu-item (click)="onAddBreak()">
              <span>Add Break</span>
            </a>

          </mat-menu>
          <button mat-button aria-label="Print Setlist" (click)="onPrintSetlist()">
            <mat-icon>print</mat-icon>
            <span>Print</span>
          </button>
          <span class="vl"></span>
          <button mat-button aria-label="Remove Song" (click)="onEnableDeleteMode()">
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
          </button>
          
          } @else {
          <button mat-icon-button aria-label="Stop Remove Song" (click)="onEnableDeleteMode()">
            <mat-icon>arrow_back</mat-icon>
          </button>
          }
        </mat-toolbar>
        <div class="table-container">
          <table mat-table cdkDropList (cdkDropListDropped)="onListDrop($event)" [dataSource]="dsSetlistSongs" matSort
            #setlistSongList="cdkDropList">
            <ng-container matColumnDef="sequence">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Num.</th>
              <td mat-cell *matCellDef="let element">
                {{
                element.isBreak === true
                ? incrementSetBreakCount(
                dsSetlistSongs.filteredData.indexOf(element)
                )
                : getSequenceNumber(
                dsSetlistSongs.filteredData.indexOf(element)
                )
                }}
              </td>
            </ng-container>
            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
              <td mat-cell *matCellDef="let element">{{ element.name }}</td>
            </ng-container>

            <!-- Artist Column -->
            <ng-container matColumnDef="artist">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Artist</th>
              <ng-container *matCellDef="let element">
              <td *ngIf="!element.isBreak" mat-cell>
                {{ element.isBreak ? ""  : element.artist }}
              </td>
              <td *ngIf="element.isBreak" mat-cell >
                Set Time: {{ getSetTimeInSeconds(element) * 1000 | date:'mm:ss'}}
              </td>
              </ng-container>
            </ng-container>

            <!-- Genre Column -->
            <ng-container matColumnDef="genre">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Genre</th>
              <ng-container *matCellDef="let element">
                <td *ngIf="!element.isBreak" mat-cell>
                  {{ element.isBreak ? "" : element.genre }}
                </td>
                <td *ngIf="element.isBreak" mat-cell >
                  Song Count: {{element.countOfSongs ? element.countOfSongs : 0 }}
                </td>
              </ng-container>
            </ng-container>

            <!-- Key Column -->
            <ng-container matColumnDef="key">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Key</th>
              <td mat-cell *matCellDef="let element">
                {{ element.isBreak ? "" : element.key }}
              </td>
            </ng-container>

            <!-- Tempo Column -->
            <ng-container matColumnDef="tempo">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Tempo</th>
              <td mat-cell *matCellDef="let element">
                {{ element.isBreak ? "" : element.tempo }}
              </td>
            </ng-container>

            <!-- Song Length Column -->
            <ng-container matColumnDef="timeSignature">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Time Signature
              </th>
              <td mat-cell *matCellDef="let element">
                {{
                element.beatValue && !element.isBreak
                ? element.beatValue + "/" + element.noteValue
                : ""
                }}
              </td>
            </ng-container>

            <!-- Song Length Column -->
            <ng-container matColumnDef="songLength">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>
                Song Length
              </th>
              <td mat-cell *matCellDef="let element">
                {{
                element.lengthMin 
                ? element.lengthMin +
                ":" +
                element.lengthSec?.toString().padStart(2, "0")
                : ""
                }}
              </td>
            </ng-container>

            <ng-container matColumnDef="lyrics">
              <th mat-header-cell [hidden]="showRemove" *matHeaderCellDef>Lyrics</th>
              <td mat-cell [hidden]="showRemove" *matCellDef="let element">
                <a href="#" *ngIf="!element.isBreak" (click)="onViewLyrics($event, element)">{{element.countOfLyrics}} Lyrics</a>
              </td>
            </ng-container>

            <ng-container matColumnDef="remove">
              <th mat-header-cell [hidden]="!showRemove" *matHeaderCellDef>
                Remove
              </th>
              <td mat-cell [hidden]="!showRemove" *matCellDef="let element">
                <a href="#" (click)="onRemoveSong($event, element)"><mat-icon>delete</mat-icon></a>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>

            <tr mat-row cdkDrag class="setlist-song-row" [cdkDragData]="row" cdkDragLockAxis="y"
              (dblclick)="onEditSong(row)" *matRowDef="let row; columns: displayedColumns" [ngClass]="{
                selected: selectedRowSequence === row.sequenceNumber, setbreak: row.isBreak && selectedRowSequence !== row.sequenceNumber
              }" (click)="selectRow(row)"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>